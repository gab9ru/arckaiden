name: Discord Webhook Embeds

on:
  push:
    branches:
      - main   # change if your default branch is different

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send commit logs as Discord embeds
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          echo "Event JSON:"
          cat "$GITHUB_EVENT_PATH"

          jq -c '.commits[]' "$GITHUB_EVENT_PATH" | while read commit; do
            author=$(echo "$commit" | jq -r '.author.name')
            full_message=$(echo "$commit" | jq -r '.message')
            url=$(echo "$commit" | jq -r '.url')

            subject=$(echo "$full_message" | head -n1)
            body=$(echo "$full_message" | tail -n +2)

            embed=$(jq -n \
              --arg title "$subject" \
              --arg url "$url" \
              --arg author "$author" \
              --arg body "$body" \
              --arg footer "Don't forget to git fetch origin" \
              '{
                title: $title,
                url: $url,
                description: ($body | if . != "" then . else $author end),
                color: 3066993,
                footer: { text: $footer }
              }'
            )

            echo "$embed" >> embeds.json
          done

          embeds=$(jq -s '.' embeds.json)
          payload=$(jq -n --argjson embeds "$embeds" '{embeds: $embeds}')

          echo "Payload to send:"
          echo "$payload"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$payload" \
               "$DISCORD_WEBHOOK"
